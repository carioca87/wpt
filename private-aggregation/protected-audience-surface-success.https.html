<!doctype html>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<script src="resources/protected-audience-helper-module.js"></script>

<body>
<script>
'use strict';

promise_test(async test => {
  const uuid = generateUuid();
  const contribution = '{ bucket: 1n, value: 1 }';
  const report = 'scoreAd';

  await runReportTest(test, uuid,
    { scoreAd:
    `privateAggregation.contributeToHistogram(${contribution});
    forDebuggingOnly.reportAdAuctionWin('${createWritingUrl(uuid, report)}');`},
    report);
}, 'contributeToHistogram() with positive bucket in scoreAd()');

promise_test(async test => {
  const uuid = generateUuid();
  const contribution = '{ bucket: 0n, value: 1 }';
  const report = 'reportResult';

  await runReportTest(test, uuid,
    { reportResult:
    `privateAggregation.contributeToHistogram(${contribution});
    sendReportTo('${createWritingUrl(uuid, report)}');`},
    report);
}, 'contributeToHistogram() with zero bucket in reportResult()');


promise_test(async test => {
  const uuid = generateUuid();
  const contribution = '{ bucket: 18446744073709551616n, value: 1 }';
  const report = 'generateBid';

  await runReportTest(test, uuid,
    { generateBid:
    `privateAggregation.contributeToHistogram(${contribution});
    forDebuggingOnly.reportAdAuctionWin('${createWritingUrl(uuid, report)}');`},
    report);
}, 'contributeToHistogram() with large bucket in generateBid()');

promise_test(async test => {
  const uuid = generateUuid();
  const contribution = '{ bucket: 340282366920938463463374607431768211455n, value: 1 }';
  const report = 'reportWin';

  await runReportTest(test, uuid,
    { reportWin:
    `privateAggregation.contributeToHistogram(${contribution});
    sendReportTo('${createWritingUrl(uuid, report)}');`},
    report);
}, 'contributeToHistogram() with max bucket in reportWin()');

promise_test(async test => {
  const uuid = generateUuid();
  const contribution = '{ bucket: 1n, value: 1 }';
  const report = 'scoreAd';

  await runReportTest(test, uuid,
    { scoreAd:
    `privateAggregation.contributeToHistogram(${contribution});
    forDebuggingOnly.reportAdAuctionWin('${createWritingUrl(uuid, report)}');`},
    report);
}, 'contributeToHistogram() with positive value in scoreAd()');

promise_test(async test => {
  const uuid = generateUuid();
  const contribution = '{ bucket: 1n, value: 0 }';
  const report = 'reportResult';

  await runReportTest(test, uuid,
    { reportResult:
    `privateAggregation.contributeToHistogram(${contribution});
    sendReportTo('${createWritingUrl(uuid, report)}');`},
    report);
}, 'contributeToHistogram() with zero value in reportResult()');

// TODO: After fix crbug.com/1459624, add a non-integer value test case here.

</script>
</body>
